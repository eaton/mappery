<!DOCTYPE html>
<html>
	<head>
		<script src="https://d3js.org/d3.v4.js"></script>
		<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
	</head>
	<body>
		<svg id="my_dataviz" width="500" height="250"></svg>
	</body>
	<script>
	// The svg
	var svg = d3.select("svg"),
		width = +svg.attr("width"),
		height = +svg.attr("height");

	// Map and projection
	var projection = d3.geoMercator()
		.scale(85)
		.translate([width/2, height/2*1.3])

	// A path generator
	var path = d3.geoPath()
		.projection(projection)
	

	// Load world shape AND list of connection
	d3.queue()
	  .defer(d3.json, "https://raw.githubusercontent.com/eaton/mappery/master/world.geojson")  // World shape
	  .defer(d3.json, "https://raw.githubusercontent.com/eaton/mappery/master/data-centers.json")  // Data centers
	  .await(ready);

	function ready(error, dataGeo, dataCenters) {

		if (error) {
			return console.warn(error);
		}

		// Generate clusters of inter-connections for each data center
		var connections = []
		dataCenters.forEach(function(source){
			if (source.links) source.links.forEach(function(target){
				loc1 = [+source.lon, +source.lat]
				targetData = dataCenters.filter(obj => { return obj.name === target })[0]
				if (targetData) {
					loc2 = [+targetData.lon, +targetData.lat]
					newLink = {type: "LineString", coordinates: [loc1, loc2]}
					connections.push(newLink)
				}
			})
		})

		// Draw the map
		svg.append("g")
			.selectAll("path")
			.data(dataGeo.features)
			.enter().append("path")
				.attr("fill", "#b8b8b8")
				.attr("d", d3.geoPath()
					.projection(projection)
				)
				.style("stroke", "#fff")
				.style("stroke-width", 1)

		// Add connections
		svg
			.selectAll("myConnections")
			.data(connections)
			.enter()
			.append("path")
				.attr("d", function(d){ return path(d)})
				.style("fill", "none")
				.style("stroke", "#666")
				.style("stroke-width", 1)
	
		// Add circles:
		svg
			.selectAll("myLocations")
			.data(dataCenters)
			.enter()
			.append("circle")
				.attr("cx", function(d){ return projection([d.lon, d.lat])[0] })
				.attr("cy", function(d){ return projection([d.lon, d.lat])[1] })
				.attr("r", 2)
				.attr("class", "circle")
				.style("fill", "black")
		

	}
	</script>
</html>
